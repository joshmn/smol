#!/usr/bin/env bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
LIB_DIR="$ROOT_DIR/lib"
OUTPUT_FILE="${1:-$ROOT_DIR/dist/smol.rb}"
MAIN_FILE="$LIB_DIR/smol.rb"

echo "building single-file smol to: $OUTPUT_FILE"

FILES=$(grep -E '^require[[:space:]]+"smol/' "$MAIN_FILE" | sed -E 's/require[[:space:]]+"([^"]+)"/\1.rb/')

{
  cat <<HEADER
# frozen_string_literal: true

# smol - a small, zero-dependency CLI and REPL framework for Ruby
# https://github.com/joshmn/smol
#
# this file was auto-generated by bin/build-single-file on $(date +%Y-%m-%d)
# drop it into your project and require it directly

require "logger"
require "readline"

HEADER

  for file in $FILES; do
    echo ""
    echo "# --- $file ---"
    echo ""
    sed -E \
      -e '/^# frozen_string_literal:/d' \
      -e '/^require[[:space:]]+"smol/d' \
      -e '/^require_relative/d' \
      "$LIB_DIR/$file"
  done

  echo ""
  echo "# --- smol.rb (main module) ---"
  echo ""
  sed -E \
    -e '/^# frozen_string_literal:/d' \
    -e '/^require[[:space:]]+"logger"/d' \
    -e '/^require[[:space:]]+"readline"/d' \
    -e '/^require[[:space:]]+"smol/d' \
    "$MAIN_FILE"

} > "$OUTPUT_FILE"

echo "done. $(wc -l < "$OUTPUT_FILE" | tr -d ' ') lines written"
